
# 1. Disable Credential Guard
reg add "HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard" /v EnableVirtualizationBasedSecurity /t REG_DWORD /d 0 /f
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" /v LsaCfgFlags /t REG_DWORD /d 0 /f

# 2. Disable HVCI (Memory Integrity)
reg add "HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard\Scenarios\HypervisorEnforcedCodeIntegrity" /v Enabled /t REG_DWORD /d 0 /f

# 3. Re-enable Restricted Admin properly
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" /v DisableRestrictedAdmin /t REG_DWORD /d 0 /f
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" /v DisableRestrictedAdminOutboundCreds /t REG_DWORD /d 0 /f

# 4. Allow delegated credentials
reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation" /v AllowDefCredentialsWhenNTLMOnly /t REG_DWORD /d 1 /f
reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation" /v ConcatenateDefaults_AllowDefNTLMOnly /t REG_DWORD /d 1 /f

# 5. Reboot required
Restart-Computer -Force










# On WIN101-05
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "DisableRestrictedAdmin" -Value 1
New-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation" -Name "RestrictedRemoteAdministration" -Value 1 -PropertyType DWord -Force
New-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation" -Name "RestrictedRemoteAdministrationType" -Value 2 -PropertyType DWord -Force

Restart-Computer -Force



# Check if enabled
Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\Microsoft\Windows\DeviceGuard

# Disable via registry
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\DeviceGuard" -Name "EnableVirtualizationBasedSecurity" -Value 0
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name "LsaCfgFlags" -Value 0



# Re-enable NLA
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 1
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "SecurityLayer" -Value 2

Restart-Service TermService -Force













# Get logoff events
Get-WinEvent -LogName Security -MaxEvents 50 | Where-Object {$_.Id -eq 4634 -or $_.Id -eq 4647} | Format-List TimeCreated, Id, Message | Select -First 5

winver
# Or
[System.Environment]::OSVersion.Version
Get-ComputerInfo | Select WindowsVersion, WindowsBuildLabEx


















# Allow multiple simultaneous sessions
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fSingleSessionPerUser" -Value 0 -Type DWord

# Restart RDP
Restart-Service TermService -Force



# Check for logoff scripts
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "legalnoticetext" -ErrorAction SilentlyContinue

# Check for auto-logoff policy
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "InactivityTimeoutSecs" -ErrorAction SilentlyContinue

# Check Event Viewer for logoff reason
Get-WinEvent -LogName System -MaxEvents 20 | Where-Object {$_.Id -eq 7002 -or $_.Id -eq 1074} | Format-List

# Check if there's something in startup causing logoff
Get-ChildItem "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"









# Check Remote Desktop licensing mode
Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections"

# Check if multiple sessions allowed
Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fSingleSessionPerUser"

# Is someone else already logged in?
query user












Get-ItemProperty -Path "HKLM:\System\Curre
ntControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication"



Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "SecurityLayer" -Value 0
Restart-Service TermService -Force



# Add teststudent01 to local Administrators
net localgroup Administrators "SCHOLARSECURE\teststudent01" /add

# Verify it's there
net localgroup Administrators

# Also verify Remote Desktop Users
net localgroup "Remote Desktop Users"






# Disable NLA completely
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Type DWord
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Type DWord

# Increase max token size (Windows 11 issue)
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\Kerberos\Parameters" -Name "MaxTokenSize" -Value 48000 -Type DWord -Force

# CRITICAL: Restart the VM (not just RDP service)
Restart-Computer -Force




# 1. Enable Remote Credential Guard (alternative to Restricted Admin)
New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "LsaCfgFlags" -Value 1 -PropertyType DWord -Force

# 2. Disable Credential Guard if enabled (can conflict)
# Check if it exists first
Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\DeviceGuard" -Name "EnableVirtualizationBasedSecurity" -ErrorAction SilentlyContinue

# 3. Add this for Windows 11 Kerberos compatibility
New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters" -Name "SupportedEncryptionTypes" -Value 0x7fffffff -PropertyType DWord -Force -ErrorAction SilentlyContinue

# If the path doesn't exist:
New-Item -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos" -Force
New-Item -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters" -Force
New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters" -Name "SupportedEncryptionTypes" -Value 0x7fffffff -PropertyType DWord -Force

# 4. Reboot
Restart-Computer -Force





Get-WinEvent -LogName Security -MaxEvents 20 | Where-Object {$_.Id -eq 4625 -or $_.Id -eq 4771} | Format-List












Restart-Service TermService -Force
Get-Service TermService






# Create the key with proper parameters
New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "DisableRestrictedAdmin" -Value 0 -PropertyType DWord -Force

# Verify it was created
Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "DisableRestrictedAdmin"

# Reboot
Restart-Computer -Force









# Check NLA (Network Level Authentication) settings
Get-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication"

# Should be 0 for SSO, 1 blocks it
# If it's 1:
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0

# Restart RDP
Restart-Service TermService -Force





# In PowerShell on WIN101-05
Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "DisableRestrictedAdmin"


# In PowerShell on WIN101-05
Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "DisableRestrictedAdmin"


net localgroup Administrators "SCHOLARSECURE\teststudent01" /add




# Allow Remote Desktop with Restricted Admin
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "DisableRestrictedAdminOutboundCreds" -Value 0 -Type DWord





# Can the VM reach anything?
ping 10.0.101.1  # Gateway
ping 8.8.8.8     # Internet
ping 192.168.50.11  # dc02

# Check network adapter
Get-NetAdapter
ipconfig /all




# Check if RDP is running
Get-Service TermService
Get-NetTCPConnection -LocalPort 3389 -State Listen

# Check Windows Firewall
Get-NetFirewallRule -DisplayGroup "Remote Desktop" | Select DisplayName, Enabled




Add-LocalGroupMember -Group "Remote Desktop Users" -Member "SCHOLARSECURE\Domain Users"

Get-Service TermService
Get-NetTCPConnection -LocalPort 3389 -State Listen





# Check for corrupted RDP components
Get-Service | Where-Object {$_.Name -like "*Term*" -or $_.Name -like "*RDP*"}

# Force reset RDP
cmd /c "netsh advfirewall firewall set rule group=\"remote desktop\" new enable=Yes"

# Delete and recreate the service registry key
Remove-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -ErrorAction SilentlyContinue
New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0 -PropertyType DWORD -Force

# Restart computer (sometimes only way to fix RDP)
Restart-Computer -Force







# Check RDP listener
qwinsta /server:localhost

# Check registry for RDP configuration
Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp'

# Try recreating RDP listener
cmd /c "reg add \"HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\" /v PortNumber /t REG_DWORD /d 3389 /f"

# Restart the service
Stop-Service TermService -Force
Start-Service TermService



# Restart RDP service
Restart-Service TermService -Force

# Wait a moment
Start-Sleep -Seconds 3

# Check if listening now
Get-NetTCPConnection -LocalPort 3389 -State Listen

# If still not listening, check RDP configuration
qwinsta



# Start Remote Desktop Services
Start-Service TermService
Set-Service TermService -StartupType Automatic

# Verify it's running
Get-Service TermService
Get-NetTCPConnection -LocalPort 3389 -State Listen

# Allow RDP through firewall
Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

# Verify RDP is listening
Get-NetTCPConnection -LocalPort 3389 -State Listen

Test-ComputerSecureChannel -Verbose

$cred = Get-Credential  # Administrator@SCHOLARSECURE.LOCAL
Add-Computer -DomainName scholarsecure.local -Credential $cred -Restart

# Set hostname in registry
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\ComputerName\ComputerName" -Name "ComputerName" -Value "WIN101-05"
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\ComputerName\ActiveComputerName" -Name "ComputerName" -Value "WIN101-05"
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name "Hostname" -Value "WIN101-05"
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name "NV Hostname" -Value "WIN101-05"

# Restart
Restart-Computer -Force



$cred = Get-Credential
Rename-Computer -NewName "WIN101-01" -DomainCredential $cred -Restart



# Set DNS to dc02
Set-DnsClientServerAddress -InterfaceAlias "Ethernet*" -ServerAddresses 192.168.50.11

# Test
nslookup scholarsecure.local

# Then rename
Rename-Computer -NewName "WIN101-01" -Restart


Get-WinEvent -LogName Security -MaxEvents 10 | Where-Object {$_.Id -eq 4625} | Format-List TimeCreated, Message


Get-WinEvent -LogName Security -MaxEvents 50 | Where-Object {$_.Properties[5].Value -eq 'teststudent01'} | Select-Object TimeCreated, Id

# Allow multiple RDP sessions
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fSingleSessionPerUser" -Value 0

# Also enable remote desktop services to allow concurrent sessions
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" -Name "fSingleSessionPerUser" -Value 0 -ErrorAction SilentlyContinue



Get-WinEvent -LogName "Microsoft-Windows-TerminalServices-LocalSessionManager/Operational" -MaxEvents 10 | Format-Table TimeCreated, Id, Message -Wrap

Get-WinEvent -LogName Security -MaxEvents 30 | Where-Object {$_.Id -in 4624,4625,4634} | Select-Object -First 10 TimeCreated, Id, @{N='Account';E={$_.Properties[5].Value}}, @{N='LogonType';E={$_.Properties[8].Value}}, @{N='Source';E={$_.Properties[18].Value}}


Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "DisableRestrictedAdmin"


Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "DisableRestrictedAdmin" -Value 0

Get-WinEvent -LogName "Microsoft-Windows-TerminalServices-LocalSessionManager/Operational" -MaxEvents 5 | Format-Table TimeCreated, Id, Message -Wrap



# Check for any errors around the login time
Get-WinEvent -LogName "Microsoft-Windows-TerminalServices-LocalSessionManager/Operational" -MaxEvents 20 | Format-Table TimeCreated, Id, Message -Wrap

# Check for any failed logon scripts
Get-WinEvent -LogName Application -MaxEvents 20 | Where-Object {$_.LevelDisplayName -eq "Error"} | Format-Table TimeCreated, Message -Wrap

hostname
net localgroup Administrators
Get-WinEvent -LogName Security -MaxEvents 50 | Where-Object {$_.Id -in 4624,4625,4634} | Select-Object -First 10 TimeCreated, Id, @{N='Account';E={$_.Properties[5].Value}}, @{N='LogonType';E={$_.Properties[8].Value}}



Add-LocalGroupMember -Group "Administrators" -Member "SCHOLARSECURE\Domain Users"
net localgroup Administrators

cat > /tmp/windows_sso_setup.ps1 << 'POWERSHELL'
#Requires -RunAsAdministrator
<#
.SYNOPSIS
    Configure Windows VM for Scholar-Secure Kerberos SSO
.DESCRIPTION
    - Enables RestrictedAdmin mode for RDP
    - Joins domain (optional)
    - Adds domain group to local Administrators
    - Enables RDP and configures firewall
    - Sets hostname (optional)
.EXAMPLE
    .\Setup-ScholarSecureVM.ps1 -Hostname "LAB-VM-101" -JoinDomain
.EXAMPLE
    .\Setup-ScholarSecureVM.ps1 -SkipDomainJoin
#>

param(
    [string]$Hostname,
    [switch]$JoinDomain,
    [switch]$SkipDomainJoin,
    [string]$DomainName = "SCHOLARSECURE.LOCAL",
    [string]$DomainOU = "OU=Lab VMs,DC=scholarsecure,DC=local",
    [string]$AdminGroup = "SCHOLARSECURE\Domain Users",
    [string]$DCAddress = "192.168.50.11"
)

$ErrorActionPreference = "Stop"

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Scholar-Secure VM SSO Setup" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan

# 1. Set hostname if provided
if ($Hostname) {
    Write-Host "`n[1/6] Setting hostname to: $Hostname" -ForegroundColor Yellow
    if ($env:COMPUTERNAME -ne $Hostname) {
        Rename-Computer -NewName $Hostname -Force
        Write-Host "  Hostname will change after reboot" -ForegroundColor Green
    } else {
        Write-Host "  Hostname already set" -ForegroundColor Green
    }
} else {
    Write-Host "`n[1/6] Skipping hostname (not specified)" -ForegroundColor Gray
}

# 2. Configure DNS to point to DC
Write-Host "`n[2/6] Configuring DNS to point to DC ($DCAddress)" -ForegroundColor Yellow
$adapters = Get-NetAdapter | Where-Object { $_.Status -eq "Up" }
foreach ($adapter in $adapters) {
    Set-DnsClientServerAddress -InterfaceIndex $adapter.ifIndex -ServerAddresses $DCAddress
    Write-Host "  Set DNS on $($adapter.Name)" -ForegroundColor Green
}

# 3. Enable RestrictedAdmin Mode (CRITICAL for Kerberos SSO)
Write-Host "`n[3/6] Enabling RestrictedAdmin Mode" -ForegroundColor Yellow
$regPath = "HKLM:\System\CurrentControlSet\Control\Lsa"
$regName = "DisableRestrictedAdmin"

# Create key if it doesn't exist
if (!(Test-Path $regPath)) {
    New-Item -Path $regPath -Force | Out-Null
}

# Set value to 0 (enabled)
Set-ItemProperty -Path $regPath -Name $regName -Value 0 -Type DWord
$value = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue
if ($value.DisableRestrictedAdmin -eq 0) {
    Write-Host "  RestrictedAdmin enabled successfully" -ForegroundColor Green
} else {
    Write-Host "  WARNING: Could not verify RestrictedAdmin setting" -ForegroundColor Red
}

# 4. Enable Remote Desktop
Write-Host "`n[4/6] Enabling Remote Desktop" -ForegroundColor Yellow

# Enable RDP
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
Write-Host "  RDP enabled" -ForegroundColor Green

# Disable NLA requirement (optional - makes testing easier)
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0
Write-Host "  NLA requirement disabled" -ForegroundColor Green

# Enable firewall rules
Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
Write-Host "  Firewall rules enabled" -ForegroundColor Green

# 5. Join Domain (if requested)
if ($JoinDomain -and !$SkipDomainJoin) {
    Write-Host "`n[5/6] Joining domain: $DomainName" -ForegroundColor Yellow
    
    # Test DC connectivity
    if (Test-Connection -ComputerName $DCAddress -Count 1 -Quiet) {
        Write-Host "  DC is reachable" -ForegroundColor Green
        
        # Prompt for credentials
        Write-Host "  Enter domain admin credentials:" -ForegroundColor Yellow
        $cred = Get-Credential -Message "Domain Admin for $DomainName"
        
        try {
            if ($DomainOU) {
                Add-Computer -DomainName $DomainName -Credential $cred -OUPath $DomainOU -Force
            } else {
                Add-Computer -DomainName $DomainName -Credential $cred -Force
            }
            Write-Host "  Domain join successful (reboot required)" -ForegroundColor Green
        } catch {
            Write-Host "  Domain join failed: $_" -ForegroundColor Red
        }
    } else {
        Write-Host "  ERROR: Cannot reach DC at $DCAddress" -ForegroundColor Red
    }
} else {
    Write-Host "`n[5/6] Skipping domain join" -ForegroundColor Gray
}

# 6. Add domain group to local Administrators
Write-Host "`n[6/6] Adding $AdminGroup to local Administrators" -ForegroundColor Yellow
try {
    Add-LocalGroupMember -Group "Administrators" -Member $AdminGroup -ErrorAction SilentlyContinue
    Write-Host "  Added $AdminGroup to Administrators" -ForegroundColor Green
} catch {
    if ($_.Exception.Message -match "already a member") {
        Write-Host "  $AdminGroup is already a member" -ForegroundColor Green
    } else {
        Write-Host "  Note: Will work after domain join and reboot" -ForegroundColor Yellow
    }
}

# Summary
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "Setup Complete!" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host @"

Configuration Applied:
  [x] RestrictedAdmin Mode: Enabled
  [x] Remote Desktop: Enabled
  [x] DNS: $DCAddress
  [x] Admin Group: $AdminGroup

Next Steps:
  1. Reboot this VM
  2. On DC, add SPN for this VM:
     sudo samba-tool delegation add-service svc_guacd 'TERMSRV/$env:COMPUTERNAME'
     sudo samba-tool delegation add-service svc_guacd 'TERMSRV/$env:COMPUTERNAME.$($DomainName.ToLower())'
  3. Test Kerberos SSO from Scholar-Secure

"@ -ForegroundColor White

$reboot = Read-Host "Reboot now? (y/n)"
if ($reboot -eq "y") {
    Restart-Computer -Force
}
POWERSHELL

cat /tmp/windows_sso_setup.ps1









































